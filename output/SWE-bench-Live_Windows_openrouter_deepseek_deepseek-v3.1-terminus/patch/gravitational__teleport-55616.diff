git --no-pager diff HEAD --diff-filter=M --text
warning: LF will be replaced by CRLF in lib/srv/desktop/discovery.go.
The file will have its original line endings in your working directory
diff --git a/lib/srv/desktop/discovery.go b/lib/srv/desktop/discovery.go        
index 3ae2011128..3de3171ae0 100644
--- a/lib/srv/desktop/discovery.go
+++ b/lib/srv/desktop/discovery.go
@@ -380,11 +380,12 @@ func (s *WindowsService) startDynamicReconciler(ctx contex
xt.Context) (*services.
        }
        s.cfg.Logger.DebugContext(ctx, "Starting dynamic desktop resource watche
er.")
        dynamicDesktopClient := s.cfg.AuthClient.DynamicDesktopClient()
-       watcher, err := services.NewDynamicWindowsDesktopWatcher(ctx, services.D
DynamicWindowsDesktopWatcherConfig{
+       dynamicWatcher, err := services.NewDynamicWindowsDesktopWatcher(ctx, ser
rvices.DynamicWindowsDesktopWatcherConfig{
                DynamicWindowsDesktopGetter: dynamicDesktopClient,
                ResourceWatcherConfig: services.ResourceWatcherConfig{
                        Component: teleport.ComponentWindowsDesktop,
                        Client:    s.cfg.AccessPoint,
+                       Logger:    s.cfg.Logger,
                },
        })
        if err != nil {
@@ -409,16 +410,24 @@ func (s *WindowsService) startDynamicReconciler(ctx contex
xt.Context) (*services.
                OnDelete: s.deleteDesktop,
        })
        if err != nil {
+               dynamicWatcher.Close()
                return nil, trace.Wrap(err)
        }
+
+       // Start periodic reconciliation to check for any missing WindowsDesktop
p resources
+       reconcileTicker := s.cfg.Clock.NewTicker(30 * time.Second)
+
        go func() {
                defer s.cfg.Logger.DebugContext(ctx, "DynamicWindowsDesktop reso
ource watcher done.")
-               defer watcher.Close()
+defer dynamicWatcher.Close()
+               defer reconcileTicker.Stop()
+
                for {
                        select {
-                       case desktops := <-watcher.ResourcesC:
+                       case dynamicDesktops := <-dynamicWatcher.ResourcesC:    
+                               // DynamicWindowsDesktop resources changed - upd
date our desktop list
                                newResources = make(map[string]types.WindowsDesk
ktop)
-                               for _, dynamicDesktop := range desktops {       
+                               for _, dynamicDesktop := range dynamicDesktops {
                                        desktop, err := s.toWindowsDesktop(dynam
micDesktop)
                                        if err != nil {
                                                s.cfg.Logger.WarnContext(ctx, "C
Can't create desktop resource", "error", err)
@@ -428,17 +437,24 @@ func (s *WindowsService) startDynamicReconciler(ctx contex
xt.Context) (*services.
                                }
                                if err := reconciler.Reconcile(ctx); err != nil 
 {
                                        s.cfg.Logger.WarnContext(ctx, "Reconcili
iation failed, will retry", "error", err)
-                                       continue
                                }
                                currentResources = newResources
-                       case <-watcher.Done():
+
+                       case <-reconcileTicker.Chan():
+// Periodic reconciliation to catch any missed d
deletions
+                               s.cfg.Logger.DebugContext(ctx, "Periodic reconci
iliation triggered")
+                               if err := reconciler.Reconcile(ctx); err != nil 
 {
+                                       s.cfg.Logger.WarnContext(ctx, "Periodic 
 reconciliation failed", "error", err)
+                               }
+
+                       case <-dynamicWatcher.Done():
                                return
                        case <-ctx.Done():
                                return
                        }
                }
        }()
-       return watcher, nil
+       return dynamicWatcher, nil
 }

 func (s *WindowsService) toWindowsDesktop(dynamicDesktop types.DynamicWindowsDe
esktop) (*types.WindowsDesktopV3, error) {
PS>
PS>prompt
